.quwan-app#quwan-app(tabindex="0")
    style.
        @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Dancing+Script:wght@400;700&family=Poppins:wght@400;600&family=Noto+Sans+SC:wght@400;700&display=swap');

        #quwan-app {
            position: relative;
            min-height: 70vh;
            border-radius: 12px;
            overflow: hidden;
            background: radial-gradient(circle at 10% 10%, #fff8fb 0%, #f0fbff 40%, #f6fff4 100%);
            font-family:"Noto Sans SC", "Poppins", sans-serif;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        #quwan-app #bgCanvas{
            position:absolute;
            inset:0;
            width:100%;
            height:100%;
            z-index:0;
            pointer-events:none;
        }

        #quwan-app .controls {
            position:absolute;
            top:18px;
            right:18px;
            z-index:10;
            display:flex;
            gap:8px;
            align-items:center;
            font-size:14px;
        }
        #quwan-app .controls button {
            background: rgba(255,255,255,0.9);
            border: none;
            padding:8px 12px;
            border-radius:12px;
            box-shadow: 0 6px 18px rgba(20,20,30,0.08);
            cursor:pointer;
            font-weight:600;
        }
        #quwan-app .controls button:active{ transform: translateY(1px); }

        #quwan-app .centerDialog {
            position:absolute;
            left:50%;
            top:50%;
            transform:translate(-50%,-50%);
            z-index:8;
            background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.94));
            border-radius:18px;
            padding:22px 28px;
            box-shadow: 0 18px 50px rgba(25,15,40,0.15);
            text-align:center;
            min-width:320px;
        }
        #quwan-app .centerDialog h2 { margin:0 0 6px 0; font-size:20px; }
        #quwan-app .centerDialog p { margin:0 0 14px 0; color:#444; }
        #quwan-app .centerDialog .btn {
            background: linear-gradient(90deg,#ff7bb0,#ffb3d9);
            border:none; color:white; padding:10px 16px; border-radius:12px; font-weight:700; cursor:pointer;
            box-shadow: 0 8px 20px rgba(255,123,176,0.25);
        }

        #quwan-app .card {
            position:absolute;
            z-index:5;
            min-width:300px; max-width:420px;
            padding:18px 20px;
            border-radius:20px;
            display:flex;
            gap:12px;
            align-items:flex-start;
            box-shadow:
                    0 20px 50px rgba(15,10,30,0.12),
                    inset 0 1px 0 rgba(255,255,255,0.25);
            border: 1px solid rgba(255,255,255,0.35);
            backdrop-filter: blur(6px);
            cursor:pointer;
            transform-origin:center center;
            transition: transform 240ms ease, opacity 350ms ease, filter 350ms ease;
        }

        #quwan-app .card .leftIcon {
            width:54px; height:54px;
            border-radius:12px;
            display:flex; align-items:center; justify-content:center;
            font-size:26px;
            flex:0 0 54px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }

        #quwan-app .card .body { flex:1; }
        #quwan-app .card .body .title { font-weight:800; font-size:16px; margin-bottom:6px; }
        #quwan-app .card .body .content { font-size:18px; line-height:1.3; word-break:break-word; }

        #quwan-app .g1 { background: linear-gradient(135deg,#fff0f6,#ffd6ea); color:#4a1630;}
        #quwan-app .g2 { background: linear-gradient(135deg,#e8f8ff,#cdeeff); color:#0b3a52;}
        #quwan-app .g3 { background: linear-gradient(135deg,#fff9e6,#ffe6c7); color:#4a3500;}
        #quwan-app .g4 { background: linear-gradient(135deg,#ecffe8,#d7ffd6); color:#063a1a;}
        #quwan-app .g5 { background: linear-gradient(135deg,#f3e8ff,#e5cbff); color:#3b1856;}
        #quwan-app .g1 .leftIcon,
        #quwan-app .g2 .leftIcon,
        #quwan-app .g3 .leftIcon,
        #quwan-app .g4 .leftIcon,
        #quwan-app .g5 .leftIcon { background: rgba(255,255,255,0.5); }

        @keyframes enterAnim {
            0% { opacity:0; transform: scale(0.5) rotate(-12deg); filter: blur(8px); }
            100% { opacity:1; transform: scale(1) rotate(0deg); filter: blur(0); }
        }
        @keyframes floatY { 0% { transform: translateY(0); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0); } }
        #quwan-app .card.floating { animation: floatY 4s ease-in-out infinite; }

        #quwan-app .font-hand { font-family: "Pacifico", "Dancing Script", cursive; }
        #quwan-app .font-script { font-family: "Dancing Script", "Pacifico", cursive; }
        #quwan-app .font-rounded { font-family: "Poppins","Noto Sans SC", "Segoe UI", sans-serif; }
        #quwan-app .font-sans { font-family: "Noto Sans SC", "Poppins", sans-serif; }

        #quwan-app .card:hover { transform: scale(1.03) translateY(-6px); filter: brightness(1.02) saturate(1.02); box-shadow: 0 30px 70px rgba(15,10,40,0.16); }
        .card.vanish-collapse { animation: vanishCollapse 300ms ease both; }

        @keyframes vanishCollapse {
            0% { transform: translateY(0) scale(1) rotate(0deg); opacity:1; filter: none; }
            35% { transform: scale(1.06) rotate(-2deg); filter: saturate(1.1); }
            100% { transform: scale(0.6) translateY(-24px) rotate(6deg); opacity:0; filter: blur(3px) brightness(1.1); }
        }

        #quwan-app .hint {
            position:absolute; left:14px; bottom:14px; z-index:9;
            background: rgba(255,255,255,0.85); padding:8px 12px; border-radius:12px; font-size:13px;
            box-shadow: 0 8px 24px rgba(20,20,40,0.06);
        }

        @media (max-width:600px){
            #quwan-app .card { min-width:260px; max-width:86%; padding:14px; border-radius:14px; }
            #quwan-app .card .leftIcon { width:48px; height:48px; font-size:20px; border-radius:10px;}
            #quwan-app .centerDialog { min-width:260px; padding:16px; border-radius:14px; }
        }

    canvas#bgCanvas

    .controls#controls(style='display:none;')
        button#pauseBtn ÊöÇÂÅúÂºπÂá∫
        button#clearBtn Ê∏ÖÁ©∫Âç°Áâá
        button#musicBtn ÊöÇÂÅúÈü≥‰πê

    .centerDialog#centerDialog
        h2 üéÅ ‰Ω†Êúâ‰∏Ä‰ªΩÊ∏©ÊöñÁöÑÁ§ºÁâ©
        p ÁÇπÂáª‰∏ãÊñπ„ÄåÊâìÂºÄ„ÄçÂºÄÂßãÊé•Êî∂ÈöèÊú∫ÊèêÁ§∫Âç°ÁâáÔºàÂèØÊöÇÂÅú/Ê∏ÖÁ©∫Ôºâ
        div(style='display:flex;justify-content:center;gap:12px;')
            button.btn#openBtn ÊâìÂºÄÁ§ºÁâ©
            button.btn#openBtn2(style='background:linear-gradient(90deg,#b8f2ff,#9fe6ff);color:#004a60') ÊâìÂºÄÔºàÈü≥‰πêÁâàÔºâ

    .hint ÁÇπÂáªÈ°µÈù¢‰ªªÊÑèÂç°ÁâáÂèØÂø´ÈÄüÊ∂àÂ§±„ÄÇËã•Èü≥‰πêÊú™Êí≠ÊîæÔºåËØ∑ÂÖàÁÇπÂáªÈ°µÈù¢‰ªªÊÑèÂ§ÑÂÖÅËÆ∏Êí≠Êîæ„ÄÇ

    audio#bgAudio(src='https://cdn.pixabay.com/audio/2022/03/15/audio_9cfae95a66.mp3' loop preload='auto')

    script(defer data-pjax).
        (function(){
            const app = document.getElementById('quwan-app');
            const centerDialog = app.querySelector('#centerDialog');
            const openBtn = app.querySelector('#openBtn');
            const openBtn2 = app.querySelector('#openBtn2');
            const controls = app.querySelector('#controls');
            const pauseBtn = app.querySelector('#pauseBtn');
            const clearBtn = app.querySelector('#clearBtn');
            const musicBtn = app.querySelector('#musicBtn');
            const bgAudio = app.querySelector('#bgAudio');
            const canvas = app.querySelector('#bgCanvas');
            const ctx = canvas.getContext('2d');
            let isMobile = window.matchMedia('(max-width: 600px)').matches;

            const MESSAGES = [
                "‰Ω†‰ªäÂ§©ÁúüÂ•ΩÁúã ‚ú®",
                "ËÆ∞ÂæóÂ§öÂñùÊ∞¥ÔºåÊ≥®ÊÑè‰ºëÊÅØ üíß",
                "‰Ω†Â∑≤ÁªèÂæàÂä™Âäõ‰∫ÜÔºåÂà´Âøò‰∫ÜÁªôËá™Â∑±Ëµû‰∏Ä‰∏™ üëç",
                "ÊÑø‰Ω†ÊâÄÊúâ‰ªòÂá∫ÈÉΩÊúâÂõûÂìç üåà",
                "ÊôöÂÆâÂ•ΩÊ¢¶ÔºåÊÑøÊòéÂ§©Êõ¥Ê∏©Êüî üåô",
                "‰øùÊåÅÂ•ΩÂ•áÔºå‰øùÊåÅÁÉ≠Áà± üî•",
                "Ëøô‰∏ÄÂàªÔºå‰Ω†ÂÄºÂæóË¢´Ê∏©Êüî‰ª•ÂæÖ üíñ",
                "Ê∑±ÂëºÂê∏‰∏Ä‰∏ãÔºå‰Ω†ÂÅöÂæóÂæàÂ•Ω üòå",
                "‰∏ñÁïåÂæàÂ§ßÔºå‰πüÂæàÊ∏©ÊüîüçÉ",
                "ÊÑø‰Ω†Ë¢´ÂñúÊ¨¢ÁöÑ‰∫∫Êã•Êä±ÔºåË¢´Ê∏©ÊüîÁöÑ‰∫∫ÂñÑÂæÖ ü´∂",
                "‰ªäÂ§©ÁöÑ‰Ω†ÂæàÈáçË¶ÅÔºå‰∏çË¶ÅÂøò‰∫ÜÂæÆÁ¨ë üòä",
                "ÁªôËá™Â∑±‰∏ÄÁÇπÊó∂Èó¥ÔºåÊÖ¢ÊÖ¢ÂèòÂº∫ üí™",
                "ÊÑø‰Ω†Ë¢´‰∏ñÁïåÊ∏©Êüî‰ª•ÂæÖÔºå‰πüË¢´Ëá™Â∑±Ê∑±Ê∑±ÂñúÊ¨¢ üíõ",
                "ÊÖ¢ÊÖ¢Êù•ÔºåÊØîËæÉÂø´ ‚è≥",
                "‰Ω†‰∏çÊòØÂ≠§Âçï‰∏Ä‰∫∫ÔºåÊàëÂú®ËøôÈáå üåü",
                "‰ªäÂ§©ÁöÑÈ£éÂæàÊ∏©ÊüîÔºå‰Ω†‰πüÊòØ üçÉ",
                "Â∏åÊúõ‰Ω†ÁöÑÊØè‰∏ÄÊ¨°Âä™ÂäõÈÉΩ‰∏çË¢´ËæúË¥ü ‚ú®",
                "ÁªôÂøÉÊîæ‰∏™ÂÅáÔºåËÆ©ÁÅµÈ≠ÇÈÄèÂè£Ê∞î üå§Ô∏è",
                "‰Ω†ÁöÑÂ≠òÂú®Êú¨Ë∫´Â∞±ÊòØ‰∏ÄÊùüÂÖâ üí°",
                "‰Ω†ÂÄºÂæóÊâÄÊúâÁæéÂ•Ω‰∏éÊúüÂæÖ üåº",
                "ÊÑø‰Ω†ÊâÄÊÉ≥ÁöÜÂ¶ÇÊÑøÔºåÊâÄË°åÁöÜÂù¶ÈÄî üö∂‚Äç‚ôÇÔ∏è",
                "Ê≤°ÊúâÁôΩËµ∞ÁöÑË∑ØÔºåÊØè‰∏ÄÊ≠•ÈÉΩÁÆóÊï∞ üõ§Ô∏è",
                "‰Ω†ÁöÑÊïÖ‰∫ãÂæàÁ≤æÂΩ©ÔºåËØ∑ÁªßÁª≠ÂÜô‰∏ãÂéª üìñ",
                "ÊÑø‰Ω†Âú®Ëá™Â∑±ÁöÑÂ∞è‰∏ñÁïåÈáåÈó™Èó™ÂèëÂÖâ ‚≠ê",
                "ËØ∑Áõ∏‰ø°Ôºå‰Ω†ÊØîËá™Â∑±ÊÉ≥Ë±°‰∏≠Êõ¥Âº∫Â§ß üí™",
                "ÊØè‰∏Ä‰∏™‰ªäÂ§©ÔºåÈÉΩÊòØÊñ∞ÁöÑÂºÄÂßã üåÖ",
                "ÁîüÊ¥ª‰ºöÂ•ñÂä±Ê∏©Êüî‰∏îÂä™ÂäõÁöÑ‰Ω† üéÅ",
                "ÂøÉÊÖ¢‰∏ÄÁÇπËµ∞ÔºåÈ£éÊôØÊâç‰ºöÊõ¥Ê∏ÖÊô∞ üëÄ",
                "‰Ω†ÂÄºÂæóË¢´ËÆ§ÁúüÂØπÂæÖÔºå‰πüÂÄºÂæóË¢´Ê∑±Ê∑±Êã•Êä± ü§ó"

            ];
            const ICONS = ["üíñ", "üå∏", "‚ú®", "üïäÔ∏è", "üåà", "‚≠ê", "üçÉ", "üéà", "üåô", "üéÄ", "üåº", "üå§Ô∏è", "üíõ", "üçÄ", "üß∏", "üéµ", "üíê", "ü™Ω", "ü™Ñ", "üåª"
            ];
            const COLOR_CLASSES = ["g1", "g2", "g3", "g4", "g5"];
            const FONT_CLASSES = ["font-hand", "font-script", "font-rounded", "font-sans", "font-cute", "font-light", "font-poetry"];


            let spawnInterval = isMobile ? 1100 : 900;
            let cardLifetime = isMobile ? 6500 : 8000;
            let spawnTimer = null;
            let running = false;

            function ensurePlayMusic() {
                bgAudio.volume = 0.35;
                bgAudio.play().catch(()=>{});
            }

            // È¶ñÊ¨°ÁÇπÂáªÂå∫ÂüüÊí≠ÊîæÈü≥‰πê
            app.addEventListener('click', function onFirstClick(){
                ensurePlayMusic();
                app.removeEventListener('click', onFirstClick);
            });

            function randomFrom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

            function pickPosition(cardWidth = (isMobile?300:360), cardHeight = (isMobile?120:130)) {
                const padding = 24;
                const ww = app.clientWidth - padding*2 - cardWidth;
                const wh = app.clientHeight - padding*2 - cardHeight;
                const left = padding + Math.random() * Math.max(0, ww);
                const top = padding + Math.random() * Math.max(0, wh);
                return {left, top};
            }

            function vanishCard(card, ms=240, burstX, burstY){
                if(!card || card._removing) return;
                card._removing = true;
                if (card._lifetime) { clearTimeout(card._lifetime); }
                card.classList.remove('floating');
                card.style.animation = '';
                card.style.transition = '';
                card.classList.add('vanish-collapse');
                if (typeof burstX === 'number' && typeof burstY === 'number') {
                    spawnBurst(burstX, burstY);
                } else {
                    const rect = card.getBoundingClientRect();
                    const appRect = app.getBoundingClientRect();
                    spawnBurst(rect.left - appRect.left + rect.width/2, rect.top - appRect.top + rect.height/2);
                }
                setTimeout(()=> { if(card && card.parentNode) card.parentNode.removeChild(card); }, 320);
            }

            function spawnCard() {
                const card = document.createElement('div');
                card.className = 'card ' + randomFrom(COLOR_CLASSES) + ' floating';

                const icon = document.createElement('div');
                icon.className = 'leftIcon';
                icon.innerText = randomFrom(ICONS);

                const body = document.createElement('div');
                body.className = 'body';

                const title = document.createElement('div');
                title.className = 'title';
                title.innerText = 'ÊèêÁ§∫';

                const content = document.createElement('div');
                content.className = 'content';
                content.innerText = randomFrom(MESSAGES);

                const fontClass = randomFrom(FONT_CLASSES);
                title.classList.add(fontClass);
                content.classList.add(fontClass);

                body.appendChild(title);
                body.appendChild(content);
                card.appendChild(icon);
                card.appendChild(body);

                const {left, top} = pickPosition();
                card.style.left = `${left}px`;
                card.style.top = `${top}px`;
                const angle = (Math.random()*24) - 12;
                card.style.transform = `rotate(${angle}deg) scale(0.98)`;
                card.style.opacity = '0';
                card.style.animation = 'none';
                app.appendChild(card);

                requestAnimationFrame(()=>{
                    card.style.animation = `enterAnim 700ms cubic-bezier(.2,.9,.3,1) forwards`;
                    card.style.opacity = '1';
                    setTimeout(()=>{
                        const finalAngle = angle + (Math.random()*8 - 4);
                        card.style.transform = `rotate(${finalAngle}deg)`;
                    }, 750);
                });

                card.addEventListener('click', (e)=>{ e.stopPropagation(); const r = app.getBoundingClientRect(); vanishCard(card, 240, e.clientX - r.left, e.clientY - r.top); });
                const lifetime = setTimeout(()=> { vanishCard(card, 800); }, cardLifetime);
                card._lifetime = lifetime;
                return card;
            }

            function startSpawning(){
                if(running) return;
                running = true;
                controls.style.display = 'flex';
                spawnTimer = setInterval(()=> spawnCard(), spawnInterval);
                pauseBtn.innerText = 'ÊöÇÂÅúÂºπÂá∫';
            }
            function stopSpawning(){
                if(!running) return;
                running = false;
                clearInterval(spawnTimer);
                spawnTimer = null;
                pauseBtn.innerText = 'ÁªßÁª≠ÂºπÂá∫';
            }

            function clearAllCards(){ Array.from(app.querySelectorAll('.card')).forEach(c => vanishCard(c, 180)); }

            openBtn.addEventListener('click', ()=>{ centerDialog.style.display = 'none'; ensurePlayMusic(); startSpawning(); });
            openBtn2.addEventListener('click', ()=>{ centerDialog.style.display = 'none'; spawnInterval = 700; ensurePlayMusic(); startSpawning(); });
            pauseBtn.addEventListener('click', ()=>{ if(running) stopSpawning(); else startSpawning(); });
            clearBtn.addEventListener('click', ()=> clearAllCards());
            musicBtn.addEventListener('click', ()=>{ if(bgAudio.paused){ bgAudio.play(); musicBtn.innerText = 'ÊöÇÂÅúÈü≥‰πê'; } else { bgAudio.pause(); musicBtn.innerText = 'Êí≠ÊîæÈü≥‰πê'; } });

            // ÂÆπÂô®Â∞∫ÂØ∏ÂèòÂåñÊó∂Ôºå‰øùËØÅÂç°Áâá‰∏çÂá∫Áïå
            const ro = new ResizeObserver(()=>{
                app.querySelectorAll('.card').forEach(c=>{
                    const rect = c.getBoundingClientRect();
                    const appRect = app.getBoundingClientRect();
                    let changed = false;
                    if(rect.right > appRect.right - 12){ c.style.left = (app.clientWidth - rect.width - 28) + 'px'; changed = true; }
                    if(rect.bottom > appRect.bottom - 12){ c.style.top = (app.clientHeight - rect.height - 28) + 'px'; changed = true; }
                    if(changed){ c.style.transition = 'left 300ms ease, top 300ms ease'; setTimeout(()=> c.style.transition = '', 350); }
                });
                resizeCanvas();
            });
            ro.observe(app);

            // ËÉåÊôØÁ≤íÂ≠ê
            let particles = [];
            let bursts = [];
            function resizeCanvas(){ canvas.width = app.clientWidth; canvas.height = app.clientHeight; isMobile = window.matchMedia('(max-width: 600px)').matches; }
            resizeCanvas();

            function createParticle(){
                const types = ['star','heart'];
                const t = types[Math.floor(Math.random()*types.length)];
                return {
                    x: Math.random()*canvas.width,
                    y: canvas.height + Math.random()*200,
                    vy: 0.3 + Math.random()*0.9,
                    vx: (Math.random()-0.5)*0.6,
                    size: 10 + Math.random()*24,
                    life: 0,
                    maxLife: 600 + Math.random()*1600,
                    type: t,
                    hue: Math.floor(Math.random()*70) + (t==='heart'?330:40)
                };
            }
            for(let i=0;i<(isMobile?40:80);i++) particles.push(createParticle());

            function drawParticle(p){
                ctx.save(); ctx.translate(p.x, p.y); ctx.globalAlpha = Math.max(0, 1 - p.life / p.maxLife);
                ctx.fillStyle = `hsl(${p.hue},80%,65%)`;
                if(p.type === 'heart'){
                    const s = p.size/12; ctx.beginPath(); ctx.moveTo(0, -8*s);
                    ctx.bezierCurveTo(-6*s, -20*s, -22*s, -6*s, 0, 12*s);
                    ctx.bezierCurveTo(22*s, -6*s, 6*s, -20*s, 0, -8*s); ctx.fill();
                } else {
                    ctx.beginPath(); const r = p.size/2;
                    for(let i=0;i<5;i++){
                        const a = (i*72 - 90) * Math.PI/180; const x = Math.cos(a)*r; const y = Math.sin(a)*r; ctx.lineTo(x,y);
                        const a2 = ((i*72+36) - 90) * Math.PI/180; ctx.lineTo(Math.cos(a2)*r/2, Math.sin(a2)*r/2);
                    }
                    ctx.closePath(); ctx.fill();
                }
                ctx.restore();
            }

            function spawnBurst(x,y){
                const pieces = [];
                const count = isMobile ? 12 : 18;
                for(let i=0;i<count;i++){
                    pieces.push({
                        angle: Math.random()*Math.PI*2,
                        speed: 1.6 + Math.random()*2.2,
                        hue: Math.floor(Math.random()*70) + 300,
                        size: 2 + Math.random()*4
                    });
                }
                bursts.push({x,y,life:0,maxLife:28,pieces});
            }

            function stepParticles(){
                ctx.clearRect(0,0,canvas.width,canvas.height);
                for(let i=0;i<particles.length;i++){
                    const p = particles[i]; p.y -= p.vy; p.x += p.vx; p.life += 1; drawParticle(p);
                    if(p.life > p.maxLife || p.y < -40 || p.x < -60 || p.x > canvas.width+60){ particles[i] = createParticle(); particles[i].y = canvas.height + Math.random()*80; }
                }
                // draw bursts
                for(let i=bursts.length-1;i>=0;i--){
                    const b = bursts[i];
                    b.life += 1;
                    const alpha = Math.max(0, 1 - b.life / b.maxLife);
                    for(let j=0;j<b.pieces.length;j++){
                        const pe = b.pieces[j];
                        const dx = Math.cos(pe.angle) * pe.speed * b.life;
                        const dy = Math.sin(pe.angle) * pe.speed * b.life;
                        ctx.save();
                        ctx.globalAlpha = alpha;
                        ctx.fillStyle = `hsl(${pe.hue},80%,60%)`;
                        ctx.beginPath();
                        ctx.arc(b.x + dx, b.y + dy, pe.size, 0, Math.PI*2);
                        ctx.fill();
                        ctx.restore();
                    }
                    if(b.life > b.maxLife) bursts.splice(i,1);
                }
                requestAnimationFrame(stepParticles);
            }
            requestAnimationFrame(stepParticles);

            controls.style.display = 'none';
            openBtn.focus();
            setTimeout(()=> controls.style.display = 'flex', 400);

            app.addEventListener('keydown',(e)=>{ if(e.code === 'Space'){ e.preventDefault(); if(running) stopSpawning(); else startSpawning(); } });
        })();
