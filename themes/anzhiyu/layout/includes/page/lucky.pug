.lucky-app#lucky-app(tabindex="0")
    style.
        #lucky-app{position:relative;min-height:70vh;border-radius:12px;overflow:hidden;background:radial-gradient(1200px 800px at 8% 12%,#fff8fb 0%,#f0fbff 40%,#f6fff4 100%);font-family:"Noto Sans SC","Poppins",sans-serif}
        #lucky-app #bgCanvas{position:absolute;inset:0;width:100%;height:100%;z-index:0;pointer-events:none}
        #lucky-app .content{position:absolute;inset:0;z-index:5}
        #lucky-app .ornaments{position:absolute;inset:0;z-index:3;pointer-events:none}
        #lucky-app .lantern{position:absolute;left:6%;top:8%;width:60px;height:80px;border-radius:26px;background:
                radial-gradient(circle at 50% 35%,#ff9a9a 0%,#ff6b6b 40%,#e63a3a 65%,#b51f1f 100%);
            box-shadow:0 12px 24px rgba(0,0,0,.18);overflow:hidden}
        #lucky-app .lantern::before{content:"";position:absolute;left:50%;top:-28px;transform:translateX(-50%);width:2px;height:28px;background:#8d1717}
        #lucky-app .lantern::after{content:"";position:absolute;left:50%;bottom:-22px;transform:translateX(-50%);width:2px;height:22px;background:#8d1717}
        #lucky-app .lantern .ribs{position:absolute;left:6px;right:6px;top:6px;bottom:6px;border-radius:20px;background:repeating-linear-gradient(90deg,rgba(255,255,255,.14) 0 2px,rgba(0,0,0,.12) 2px 4px);mix-blend-mode:soft-light;opacity:.35}
        #lucky-app .lantern .rim-top{position:absolute;left:50%;top:-6px;transform:translateX(-50%);width:46px;height:12px;border-radius:10px;background:linear-gradient(180deg,#f7d77e,#d3a84b);box-shadow:0 4px 8px rgba(0,0,0,.12)}
        #lucky-app .lantern .rim-bottom{position:absolute;left:50%;bottom:-6px;transform:translateX(-50%);width:46px;height:12px;border-radius:10px;background:linear-gradient(180deg,#f7d77e,#d3a84b);box-shadow:0 -2px 6px rgba(0,0,0,.12)}
        #lucky-app .lantern .knot{position:absolute;left:50%;bottom:-10px;transform:translateX(-50%);width:14px;height:14px;border-radius:50%;background:#b6021a;border:2px solid #ffd36b;box-shadow:0 2px 6px rgba(0,0,0,.15)}
        #lucky-app .lantern .fringe{position:absolute;left:50%;bottom:-34px;transform:translateX(-50%);width:52px;height:24px}
        #lucky-app .lantern .fringe .strand{position:absolute;bottom:0;width:2px;height:24px;background:linear-gradient(180deg,#c51414,#9e1c1c);border-radius:2px}
        #lucky-app .lantern .fringe .strand:nth-child(1){left:6px}
        #lucky-app .lantern .fringe .strand:nth-child(2){left:16px}
        #lucky-app .lantern .fringe .strand:nth-child(3){left:26px}
        #lucky-app .lantern .fringe .strand:nth-child(4){left:36px}
        #lucky-app .lantern .fringe .strand:nth-child(5){left:46px}
        #lucky-app .lantern{animation:lanternSwing 5s ease-in-out infinite}
        @keyframes lanternSwing{0%{transform:rotate(-2deg)}50%{transform:rotate(2deg)}100%{transform:rotate(-2deg)}}
        #lucky-app .cloud{position:absolute;width:220px;height:110px;filter:drop-shadow(0 10px 22px rgba(0,0,0,.1))}
        #lucky-app .cloud .p{position:absolute;border-radius:50%;background:radial-gradient(circle at 40% 40%,rgba(255,255,255,.98) 0%,rgba(246,249,255,.92) 60%,rgba(230,238,248,.85) 100%)}
        #lucky-app .cloud.left{left:10%;top:24%;animation:floatCloud 16s ease-in-out infinite}
        #lucky-app .cloud.right{right:8%;top:18%;animation:floatCloud 18s ease-in-out infinite}
        @keyframes floatCloud{0%{transform:translate(0,0)}50%{transform:translate(24px,2px)}100%{transform:translate(0,0)}}
        #lucky-app .table-shadow{position:absolute;left:50%;top:55%;transform:translateX(-50%);width:380px;height:40px;background:radial-gradient(ellipse at 50% 50%,rgba(0,0,0,.18),transparent 70%);filter:blur(10px)}
        #lucky-app .petals{position:absolute;inset:0;pointer-events:none}
        #lucky-app .petal{position:absolute;width:var(--size,14px);height:calc(var(--size,14px)*.72);left:calc(10% + var(--x,0px));top:-24px;border-radius:12px 12px 14px 14px/10px 10px 12px 12px;background:
                radial-gradient(ellipse at 40% 35%,#ffe3ea 0%,#ffd1dc 40%,#ffb3c1 100%);
            box-shadow:0 4px 8px rgba(0,0,0,.12);opacity:.85;transform-origin:center;animation:petalFall calc(8s + var(--d,0s)) linear infinite;animation-delay:var(--delay,0s)}
        #lucky-app .petal::after{content:"";position:absolute;right:18%;top:22%;width:22%;height:24%;border-radius:50%;background:rgba(255,255,255,.55);filter:blur(1px)}
        @keyframes petalFall{0%{transform:translate(0,0) rotate(-20deg)}25%{transform:translate(60px,140px) rotate(0deg)}50%{transform:translate(120px,280px) rotate(18deg)}75%{transform:translate(180px,420px) rotate(0deg)}100%{transform:translate(240px,560px) rotate(22deg);opacity:0}}
        #lucky-app .stage{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);display:flex;flex-direction:column;align-items:center;gap:16px;z-index:6}
        #lucky-app .paper{position:relative;left:50%;top:0;transform:translateX(-50%) scaleX(.08);transform-origin:left center;width:360px;height:200px;border-radius:14px;background:linear-gradient(180deg,#fff,#f9f7f3);box-shadow:0 16px 28px rgba(0,0,0,0.12), inset 12px 0 18px rgba(0,0,0,.05);display:flex;align-items:center;justify-content:center;overflow:hidden}
        #lucky-app .paper::before{content:"";position:absolute;inset:0;border-radius:12px;opacity:.45;pointer-events:none;background:
                repeating-linear-gradient(90deg,rgba(0,0,0,.025) 0 2px,transparent 2px 4px),
                repeating-linear-gradient(0deg,rgba(0,0,0,.02) 0 3px,transparent 3px 6px)}
        #lucky-app .paper::after{content:"";position:absolute;left:-18px;top:0;width:18px;height:100%;border-radius:14px;background:linear-gradient(90deg,rgba(0,0,0,.18),rgba(0,0,0,.06),transparent);filter:blur(2px)}
        #lucky-app .rod{position:absolute;top:50%;transform:translateY(-50%);width:18px;height:92%;border-radius:12px;background:linear-gradient(180deg,#c89a62,#a7793f 60%,#8a5f2c);box-shadow:inset -2px 0 4px rgba(0,0,0,.25),0 8px 18px rgba(0,0,0,.12)}
        #lucky-app .rod.left{left:-20px}
        #lucky-app .rod.right{right:-20px}
        #lucky-app .rod::before{content:"";position:absolute;left:50%;top:-8px;transform:translateX(-50%);width:22px;height:16px;border-radius:10px;background:linear-gradient(180deg,#cfa56f,#a7793f)}
        #lucky-app .rod::after{content:"";position:absolute;left:50%;bottom:-8px;transform:translateX(-50%);width:22px;height:16px;border-radius:10px;background:linear-gradient(180deg,#cfa56f,#a7793f)}
        #lucky-app .edge{position:absolute;top:0;width:10px;height:100%;pointer-events:none}
        #lucky-app .edge.left{left:0;background:repeating-linear-gradient(180deg,rgba(0,0,0,.06) 0 6px,rgba(0,0,0,.12) 6px 7px,transparent 7px 13px);filter:blur(0.6px);opacity:.25}
        #lucky-app .edge.right{right:0;background:repeating-linear-gradient(180deg,rgba(0,0,0,.06) 0 6px,rgba(0,0,0,.12) 6px 7px,transparent 7px 13px);filter:blur(0.6px);opacity:.25}
        #lucky-app .rope{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:200px;height:12px;background:linear-gradient(90deg,#d9001b,#ff3b3b);border-radius:8px;box-shadow:0 4px 10px rgba(220,0,30,.25)}
        #lucky-app .slip-content{writing-mode:vertical-rl;font-weight:800;letter-spacing:2px;color:#1b1b1b;font-family:"KaiTi","STKaiti","Noto Serif SC","Songti SC",serif}
        #lucky-app .unroll{animation:unroll 1200ms cubic-bezier(.2,.9,.3,1) forwards}
        #lucky-app .float{animation:paperFloat 5s ease-in-out infinite}
        #lucky-app .rope.untie{animation:untie 500ms ease forwards}
        @keyframes unroll{0%{transform:translateX(-50%) scaleX(.08)}100%{transform:translateX(-50%) scaleX(1)}}
        @keyframes paperFloat{0%{transform:translateX(-50%) translateY(0) rotate(0deg) scaleX(1)}50%{transform:translateX(-50%) translateY(2px) rotate(0.5deg) scaleX(1)}100%{transform:translateX(-50%) translateY(0) rotate(0deg) scaleX(1)}}
        @keyframes untie{0%{opacity:1}100%{opacity:0}}
        #lucky-app .reroll{animation:reroll 900ms cubic-bezier(.3,.8,.4,1) forwards}
        @keyframes reroll{0%{transform:translateX(-50%) scaleX(1)}100%{transform:translateX(-50%) scaleX(.08)}}
        #lucky-app .controls{display:flex;gap:10px;align-items:center}
        #lucky-app button{background:rgba(255,255,255,0.9);border:none;padding:10px 16px;border-radius:12px;box-shadow:0 8px 20px rgba(20,20,30,0.1);cursor:pointer;font-weight:700}
        #lucky-app button.primary{background:linear-gradient(90deg,#7bb6ff,#9fe6ff);color:#004a60}
        #lucky-app .secondary{background:linear-gradient(90deg,#ffd6e6,#ffb3d9);color:#6a1840}
        #lucky-app .meta{display:flex;justify-content:space-between;align-items:center;width:100%}
        #lucky-app .fav{cursor:pointer;font-weight:700}
        #lucky-app .fav.on{color:#e85c89}
        @media(max-width:600px){
            #lucky-app .paper{width:300px;height:180px}
            #lucky-app .cloud{width:140px;height:70px;opacity:.65}
            #lucky-app .cloud.left{left:2%;top:6%}
            #lucky-app .cloud.right{right:2%;top:6%}
            #lucky-app .lantern{left:4%;top:6%;width:44px;height:60px}
            #lucky-app .lantern .rim-top,#lucky-app .lantern .rim-bottom{width:38px}
        }

    canvas#bgCanvas

    .content
        .ornaments
            .lantern
                .ribs
                .rim-top
                .rim-bottom
                .knot
                .fringe
                    span.strand
                    span.strand
                    span.strand
                    span.strand
                    span.strand
            .cloud.left
                .p(style="left:10px;top:28px;width:80px;height:80px")
                .p(style="left:60px;top:10px;width:90px;height:90px")
                .p(style="left:120px;top:34px;width:70px;height:70px")
            .cloud.right
                .p(style="left:20px;top:20px;width:80px;height:80px")
                .p(style="left:70px;top:6px;width:96px;height:96px")
                .p(style="left:130px;top:32px;width:74px;height:74px")
            .table-shadow
            .petals
                span.petal(style="--x:0; --d:0s; --delay:0s; --size:14px")
                span.petal(style="--x:40px; --d:1s; --delay:.5s; --size:16px")
                span.petal(style="--x:80px; --d:1.6s; --delay:1.2s; --size:12px")
                span.petal(style="--x:120px; --d:.8s; --delay:2s; --size:15px")
                span.petal(style="--x:160px; --d:1.4s; --delay:2.4s; --size:13px")
                span.petal(style="--x:200px; --d:1.1s; --delay:3s; --size:16px")
                span.petal(style="--x:240px; --d:1.8s; --delay:3.6s; --size:12px")
                span.petal(style="--x:280px; --d:1.3s; --delay:4.2s; --size:15px")
                span.petal(style="--x:320px; --d:1.7s; --delay:4.8s; --size:13px")
                span.petal(style="--x:360px; --d:1.2s; --delay:5.4s; --size:16px")
        .stage
            .paper
                .rod.left
                .rod.right
                .edge.left
                .edge.right
                .rope
                .slip-content#slipText
            .controls
                button#drawBtn.primary 抽一签
                button#resetBtn.secondary 重置
                button#copyBtn 复制
            .meta
                span#status 今日未抽
                span#favBtn.fav ☆ 收藏

    script(defer data-pjax).
        (function(){
            const app = document.getElementById('lucky-app');
            const drawBtn = app.querySelector('#drawBtn');
            const resetBtn = app.querySelector('#resetBtn');
            const copyBtn = app.querySelector('#copyBtn');
            const favBtn = app.querySelector('#favBtn');

            const paperEl = app.querySelector('.paper');
            const slipText = app.querySelector('#slipText');
            const ropeEl = app.querySelector('.rope');
            const statusEl = app.querySelector('#status');
            const canvas = app.querySelector('#bgCanvas');
            const ctx = canvas.getContext('2d');
            let isMobile = window.matchMedia('(max-width: 600px)').matches;

            const KEY_DATE = 'lucky_draw_date';
            const KEY_RESULT = 'lucky_draw_result';
            const KEY_FAVS = 'lucky_draw_favs';

            const MESSAGES = ["愿你始终保持热爱", "答案正在靠近你", "今天会有好事发生", "选择会带来新的可能", "你的坚持终将闪光", "别急，时间会给你答案", "心怀期待，一切都会更好", "你正在被幸运眷顾", "相信自己的直觉", "前路光明且温柔", "你的努力会被看到", "继续走，风会吹来方向", "你值得被温柔以待", "请大胆一点，命运会奖励勇敢的人", "答案就在你心里", "放轻松，一切尽在掌控", "保持积极，奇迹就在路上", "你的愿望正在实现", "做你该做的，剩下的交给时间", "世界会为你让路", "你的未来正在发光", "好消息正在赶来", "选择让你更快乐", "此刻正适合开始", "今天适合行动", "再坚持一下就好了", "相信你会做对", "你正走在正确的道路上", "把心放稳，一切如愿", "放下焦虑，轻装前行", "你的好运已在路上", "你值得拥有最好的一切", "请继续期待生活", "答案会在最合适的时间出现", "你的选择会带来祝福", "保持善良，它会把好运带给你", "你已经做得很好了", "结果会比你想的更好", "放心去做吧", "新的篇章即将开启", "宇宙正在回应你的请求", "你值得被拥抱与理解", "好事会发生在你身上", "你的笑容会治愈一切", "耐心一点，惊喜会出现", "你比自己想象中更强大", "接下来会越来越顺利", "你正在吸引美好发生", "未来会按你喜欢的方式展开", "你正在靠近幸福", "一切都会变得简单", "你的能力足以应对一切", "不用怀疑，答案是肯定的", "你会得到你想要的", "所有努力都在发芽", "继续前行，你会看到光", "你会做出最正确的选择", "别担心，一切都安排好了", "你会迎来圆满结局", "答案就在不远处", "幸运会突然降临", "你的愿望会被实现", "你正在经历的是成长", "再给自己一点时间", "你的故事会很精彩", "你会遇到更好的自己", "你将迎来意想不到的惊喜", "你的坚持会得到回报", "未来会温柔拥抱你", "答案正在慢慢浮现", "你值得更好的未来", "会有人温柔接住你", "你的好运正在积累", "请对自己多一点耐心", "你会做得比现在更好", "放下不安，迎接新生", "生活不会亏待努力的人", "请继续往梦的方向走", "你会遇见很多美好的人", "好运会以另一种方式到来", "属于你的不会错过", "你的光芒无人能挡", "你会得到意料之外的认可", "你正在被爱包围", "你的灵感会源源不断", "你会做出正确决定", "未来比现在更值得期待", "请继续保持勇敢", "你的温柔值得被珍惜", "你会越来越自由", "你会获得稳稳的幸福", "你的付出都会以惊喜回馈", "你已经足够优秀", "你会迎来柳暗花明", "你的路正在被照亮", "你会遇见更好的风景", "你的心会越来越轻松", "你会吸引到真正属于你的", "你会解决所有问题", "你不会失去任何值得的东西", "你会在关键时刻得到帮助", "请勇敢迈出第一步", "你的愿望会开花", "你将变得更加强大", "你的每一步都算数", "未来会给你更多选择", "你的好运藏在坚持里", "你所期待的正在靠近", "你会遇见心里的答案", "你会赢得属于你的掌声", "你会迎来新的开始", "你的努力不会白费", "你值得被世界温柔相待", "你的心愿会被听见", "你会跨过所有难关", "你将迎来命运的礼物", "你的路会越走越宽", "你会拥有真正的快乐", "你正在吸引所有美好", "你会成为你想成为的人", "你会遇见更懂你的人", "你会在正确的时间做正确的事", "你的未来会熠熠生辉", "你会得到意想不到的支持", "你的心会更加坚定", "你会得到内心的平静", "你会享受每一个当下", "你会被幸运选中", "你会迎来突破性的改变", "你会得到你应得的赞赏", "你会在混乱中找到方向", "你的决定会带来好运", "你会发现一切都是最好的安排", "你会拥有更好的心态", "你会被温柔的人围绕", "你会比现在更快乐", "你会发现事情比想象的简单", "你正在成为更坚强的人", "你会治愈所有过去", "你会照亮别人的世界", "你的梦想会被认真对待", "你会拥有坚定的力量", "你会迎来新的希望", "你的善良会被世界记住", "你会接收到重要的信息", "你会得到让你惊讶的答案", "你会遇见改变你的人", "你会找到属于你的归属", "你会活成你喜欢的样子", "你会被命运偏爱", "一切困难都将迎刃而解", "你会拥有更广阔的舞台", "你会变得更加洒脱", "你会遇到转机", "你不会被辜负", "你会收到期待已久的回应", "你会找到心里的平衡", "你会迎来好运爆发期", "你会遇到心软的人", "你会被珍惜和拥抱", "你会感受到真正的轻松", "你会拥有坚定的信念", "你会得到心里的答案", "你会勇敢面对一切", "你会成为更好的自己", "你会遇到真正懂你的人", "你会接近你渴望的生活", "你会感受到幸福靠近", "你会迎来更亮的未来", "你会遇到触动心的人", "你会得到意外的好运", "你会迎来新的力量", "你会感到被支持", "你会看清真正重要的事", "你会迎来命运的馈赠", "你会在平凡中看到惊喜", "你会为自己感到骄傲", "你会拥有温柔的答案", "你正在被幸运挑选", "你所期待的正在路上", "你会在迷茫后找到方向", "你会迎来温柔的风", "你会被证明选对了方向", "你会收获前所未有的安心", "你会变得更加从容", "你的决定会带来光", "你会被生活温柔照顾", "你会拥有更多勇气", "你会忘记所有不快", "你会迎来情绪的晴天", "你会活得更加坦然", "你会遇到令人安心的人", "你会迎来新的契机", "你会看见更清晰的未来", "你会得到稳稳的支持", "你会拥抱更真实的自己", "你会被温暖的人治愈", "你会拥有值得期待的日子", "你会迎来更大的惊喜", "你会得到心安的结局", "你会吸引更多好运", "你会发现生活越来越顺", "你会遇到善意与温柔", "你会被命运照亮", "你会迎来新的好运周期", "你会越来越喜欢现在的生活", "你会轻松解决烦恼", "你会迎来值得庆祝的时刻", "你会得到你渴望的认可", "你会迎来久违的轻松", "你会遇到让你安心的人", "你会迎来新的成长", "你会有更坚定的方向", "你会得到意料之外的力量", "你会更加相信自己", "你会在关键时刻被帮助", "你会在混乱中保持清醒", "你会得到属于你的温柔回应", "你会迎来命运的惊喜", "你会被生活轻轻拥抱", "你会迎来久违的好运", "你会看到努力的意义", "你会遇到新的希望", "你会收获幸福的答案", "你会找到想要的平衡", "你会得到值得的回报", "你会拥有真正的自由", "你会遇到值得托付的人", "你会迎来期待的变化", "你会看到心里的曙光", "你会得到命运的眷顾", "你会迎来温暖的突破", "你会越来越自信", "你会发现生活更温柔了", "你会遇见更广阔的未来", "你会找到你的节奏", "你会迎来更坦荡的日子", "你会遇到更好的自己", "你会被世界认真对待", "你会迎来久违的幸运", "你会明白一切都是值得的", "你会遇到属于你的答案", "你会得到命运的示意", "你会做出伟大的选择", "你会迎来真正的快乐", "你会相信一切变得更好", "你会感到心安理得", "你会被治愈", "你会被温柔以待", "你会迎来新的机遇", "你会享受当下的每一刻", "你会收获更坚定的勇气", "你会找到你的方向", "你会遇到更好的可能", "你会迎来新的希望与光", "你会得到你想象不到的好运", "你会走向更好的未来", "你会遇到真正重要的人", "你会成为光", "你会被温暖包围", "你会拥有真正的快乐时刻", "你会遇见命运的安排", "你会迎来真正的答案", "你会拥有足够的力量", "你会找到值得坚持的方向", "你会迎来全新的自己", "你会被善意环绕", "你会拥有值得托付的未来", "你会迎来更灿烂的日子", "你会拥有想象不到的幸福", "你会遇到命中注定的礼物", "你会越来越热爱生活", "你会迎来所有美好", "你会得到不可思议的支持", "你会看到生命的惊喜", "你会迎来柔软的风", "你会被命运温柔相待", "你会在未来的日子里发光", "你会得到更真诚的爱", "你会成为最好的自己", "你会迎来闪闪发亮的时刻", "你会收获满满的安心", "你会被爱包围", "你会迎来所有答案的到来", "你会拥有真正的力量", "你会被理解", "你会得到最温柔的回应", "你会迎来重要的改变", "你会收获真正的成功", "你会被生活轻轻拥抱", "你会遇到值得庆祝的日子", "你会被世界温柔回馈", "你会迎来心里的春天", "你会得到你一直等待的", "你会遇见命运的善意", "你会有被选中的感觉", "你会拥有更广阔的天空", "你会拥有不可替代的价值", "你会在未来的日子里闪耀", "你会慢慢接近幸福", "你会遇到对的人", "你会迎接新的旅程", "你会得到命运的指引", "你会看见惊喜落地", "你会变得越来越轻松", "你会迎来真正的答案", "你会被珍惜", "你会得到命运的加持", "你会收获越来越多的爱", "你会迎来最温柔的礼物", "你会走向理想生活", "你会收到来自世界的温柔", "你会迎来发光的机会", "你会成为值得的人", "你会看到所有努力的意义", "你会迎来属于你的星光", "你会找到你想要的未来", "你会迎来顺风顺水的日子", "你会迎来心里的光亮", "你会被幸运紧紧拥抱", "你会走向更幸福的旅程", "你会迎来你梦寐以求的答案"];


            function todayStr(){ const d = new Date(); const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
            function pickRandom(){ return MESSAGES[Math.floor(Math.random()*MESSAGES.length)]; }
            function loadFavs(){ try{ return JSON.parse(localStorage.getItem(KEY_FAVS)||'[]'); }catch(e){ return []; } }
            function saveFavs(arr){ localStorage.setItem(KEY_FAVS, JSON.stringify(arr)); }

            function spawnBurst(x,y){
                const count = isMobile ? 10 : 16;
                for(let i=0;i<count;i++){
                    const angle = Math.random()*Math.PI*2;
                    const hues = [12,18,46,52];
                    const hue = hues[Math.floor(Math.random()*hues.length)];
                    particles.push({ x, y, vx: Math.cos(angle)*(1.4+Math.random()*1.6), vy: Math.sin(angle)*(1.4+Math.random()*1.6), life:0, maxLife:26+Math.random()*18, size:2+Math.random()*3, hue });
                }
            }

            let particles = [];
            function resizeCanvas(){ canvas.width = app.clientWidth; canvas.height = app.clientHeight; isMobile = window.matchMedia('(max-width: 600px)').matches; }
            resizeCanvas();
            function step(){
                ctx.clearRect(0,0,canvas.width,canvas.height);
                for(let i=particles.length-1;i>=0;i--){
                    const p = particles[i];
                    p.x += p.vx; p.y += p.vy; p.life += 1;
                    const alpha = Math.max(0, 1 - p.life/p.maxLife);
                    ctx.save(); ctx.globalAlpha = alpha; ctx.fillStyle = `hsl(${p.hue},80%,60%)`; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill(); ctx.restore();
                    if(p.life > p.maxLife) particles.splice(i,1);
                }
                requestAnimationFrame(step);
            }
            requestAnimationFrame(step);

            function clearSlip(){
                paperEl.classList.remove('unroll','float','reroll');
                ropeEl.classList.remove('untie');
                paperEl.style.transform = 'translateX(-50%) scaleX(.08)';
                slipText.innerText = '';
            }

            function render(){
                const storedDate = localStorage.getItem(KEY_DATE);
                const stored = localStorage.getItem(KEY_RESULT);
                const favs = loadFavs();
                clearSlip();
                if(stored && storedDate === todayStr()){
                    statusEl.innerText = '今日已抽';
                    drawBtn.innerText = '已抽';
                    drawBtn.disabled = true;
                    favBtn.classList.toggle('on', favs.includes(stored));
                    slipText.innerText = stored;
                    ropeEl.classList.add('untie');
                    paperEl.classList.add('unroll');
                    setTimeout(()=>{ paperEl.classList.add('float'); }, 900);
                }else{
                    statusEl.innerText = '今日未抽';
                    drawBtn.innerText = '抽一签';
                    drawBtn.disabled = false;
                    favBtn.classList.remove('on');
                    clearSlip();
                }
            }

            drawBtn.addEventListener('click', ()=>{
                const storedDate = localStorage.getItem(KEY_DATE);
                const stored = localStorage.getItem(KEY_RESULT);
                if(stored && storedDate === todayStr()){
                    window.anzhiyu && anzhiyu.snackbarShow && anzhiyu.snackbarShow('今日已抽');
                    return;
                }
                const msg = pickRandom();
                localStorage.setItem(KEY_DATE, todayStr());
                localStorage.setItem(KEY_RESULT, msg);
                statusEl.innerText = '今日已抽';
                drawBtn.innerText = '已抽';
                drawBtn.disabled = true;
                slipText.innerText = msg;
                ropeEl.classList.add('untie');
                setTimeout(()=>{ paperEl.classList.add('unroll'); }, 200);
                setTimeout(()=>{ paperEl.classList.add('float'); }, 1100);
                const sr = paperEl.getBoundingClientRect();
                const ar = app.getBoundingClientRect();
                spawnBurst(sr.left - ar.left + sr.width/2, sr.top - ar.top);
            });

            resetBtn.addEventListener('click', ()=>{
                localStorage.removeItem(KEY_DATE);
                localStorage.removeItem(KEY_RESULT);
                paperEl.classList.remove('float');
                paperEl.classList.add('reroll');
                paperEl.addEventListener('animationend', ()=>{
                    paperEl.classList.remove('reroll');
                    render();
                    window.anzhiyu && anzhiyu.snackbarShow && anzhiyu.snackbarShow('已重置');
                }, { once: true });
            });

            copyBtn.addEventListener('click', async ()=>{
                const txt = slipText.innerText.trim();
                if(!txt){ window.anzhiyu && anzhiyu.snackbarShow && anzhiyu.snackbarShow('还没有内容'); return; }
                try{ await navigator.clipboard.writeText(txt); window.anzhiyu && anzhiyu.snackbarShow && anzhiyu.snackbarShow('已复制'); }catch(e){ }
            });

            favBtn.addEventListener('click', ()=>{
                const txt = slipText.innerText.trim();
                if(!txt){ window.anzhiyu && anzhiyu.snackbarShow && anzhiyu.snackbarShow('还没有内容'); return; }
                const favs = loadFavs();
                const i = favs.indexOf(txt);
                if(i>=0){ favs.splice(i,1); favBtn.classList.remove('on'); window.anzhiyu && anzhiyu.snackbarShow && anzhiyu.snackbarShow('已取消收藏'); }
                else{ favs.push(txt); favBtn.classList.add('on'); window.anzhiyu && anzhiyu.snackbarShow && anzhiyu.snackbarShow('已收藏'); }
                saveFavs(favs);
            });

            window.addEventListener('resize', ()=>{ resizeCanvas(); });
            render();
        })();
