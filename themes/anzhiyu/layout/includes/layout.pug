- var htmlClassHideAside = theme.aside.enable && theme.aside.hide ? 'hide-aside' : ''
- page.aside = is_archive() ? theme.aside.display.archive: is_category() ? theme.aside.display.category : is_tag() ? theme.aside.display.tag : page.aside
- var hideAside = !theme.aside.enable || page.aside === false ? 'hide-aside' : ''
- var pageType = is_post() ? 'post' : 'page'

doctype html
html(lang=config.language data-theme=theme.display_mode class=htmlClassHideAside)
  head
    include ./head.pug
  body(data-type="anzhiyu")
    #web_bg
    #an_music_bg
    if theme.preloader.enable
      !=partial('includes/loading/index', {}, {cache: true})
    if (theme.mourn.enable && is_home_first_page())
      include ./mourn.pug
    if page.type !== '404'
      #body-wrap(class=pageType)
        include ./header/index.pug
        main#blog-container
          if (is_home())
            include ./bbTimeList.pug
          if is_current("/")
            include ./top/top.pug
          if page.top_single
            - let background = page.top_single_background
            - let tip = page.top_single_tip
            - let subTitle = page.top_single_subtitle
            - let btn_link = page.top_single_btn_link
            - let btn_text = page.top_single_btn_text
            #single_top
              .author-content.author-content-item.single(style=`${background ? `background: url(${background}) top / cover no-repeat;` : ""}`)
                .card-content
                  .author-content-item-tips=subTitle
                  span.author-content-item-title=page.title
                  .content-bottom
                    .tips=tip
                  .banner-button-group
                    a.banner-button(onclick=`pjax.loadUrl("${url_for(btn_link ? btn_link : '/about')}")`)
                      i.anzhiyufont.anzhiyu-icon-arrow-circle-right(style='font-size: 1.5rem')
                      span.banner-button-text=btn_text ? btn_text : "关于我"

          #content-inner.layout(class=hideAside)
            if body
              div!= body
            else
              block content
              if theme.aside.enable && page.aside !== false
                include widget/index.pug

        - var footerBg = theme.footer_bg
        if (footerBg)
          if (footerBg === true)
            - var footer_bg = bg_img
          else
            - var footer_bg = theme.footer_bg.indexOf('/') !== -1 ? `background-image: url('${url_for(footerBg)}')` : `background: ${footerBg}`
        else
          - var footer_bg = ''

        footer#footer(style=footer_bg)
          !=partial('includes/footer', {}, {cache: true})
        if is_home_first_page()
          style.
            #holiday-overlay{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .4s ease}
            #holiday-overlay.on{opacity:1;pointer-events:auto}
            #holiday-overlay .backdrop{position:absolute;inset:0;background:radial-gradient(1200px 800px at 50% 20%,rgba(255,245,230,.95),rgba(255,230,240,.9),rgba(230,240,255,.88));backdrop-filter:blur(4px);z-index:0;pointer-events:none}
            #holiday-overlay .card{position:relative;width:min(92vw,560px);border-radius:18px;padding:28px 26px;background:linear-gradient(180deg,#fffef9,#fff6f1);box-shadow:0 30px 60px rgba(0,0,0,.18);transform:scale(.86);opacity:0;animation:popIn .6s cubic-bezier(.2,.9,.3,1) .1s forwards;z-index:2}
            #holiday-overlay .card::before{content:"";position:absolute;inset:-2px;border-radius:20px;background:conic-gradient(from 0deg,#ffd36b,#ff94c2,#9fe6ff,#ffd36b);filter:blur(12px);opacity:.35;animation:glow 6s linear infinite;pointer-events:none}
            #holiday-overlay .title{font-size:28px;font-weight:900;letter-spacing:2px;color:#a2162b;text-align:center}
            #holiday-overlay .date{margin-top:6px;text-align:center;color:#6b6b6b;font-weight:700}
            #holiday-overlay .msg{margin:16px 0 22px;color:#2b2b2b;line-height:1.8;text-align:center;font-weight:700}
            #holiday-overlay .btn{display:block;margin:0 auto;padding:10px 18px;border:none;border-radius:12px;background:linear-gradient(90deg,#ff9bb0,#ffd36b);color:#411c1c;font-weight:900;cursor:pointer;box-shadow:0 12px 24px rgba(0,0,0,.12)}
            #holiday-overlay .confetti{position:absolute;inset:0;pointer-events:none;z-index:1}
            #holiday-overlay .confetti .p{position:absolute;width:8px;height:12px;border-radius:2px;opacity:.9}
            #holiday-overlay #holidayFX{position:absolute;inset:0;z-index:1;pointer-events:none;display:none}
            #holiday-overlay.spring #holidayFX{display:block}
            #holiday-overlay.spring .backdrop{background:radial-gradient(1200px 800px at 50% 20%,rgba(255,235,230,.95),rgba(255,220,220,.92),rgba(250,240,240,.9))}
            #holiday-overlay.spring .btn{background:linear-gradient(90deg,#ff6b6b,#ffd36b);color:#4a1616}
            #holiday-overlay.spring .title{color:#b51220}
            #holiday-overlay.dragon .backdrop{background:radial-gradient(1200px 800px at 50% 20%,rgba(235,255,245,.95),rgba(210,250,230,.92),rgba(210,240,225,.9))}
            #holiday-overlay.dragon .btn{background:linear-gradient(90deg,#22c55e,#9fe6ff);color:#0a3a2e}
            #holiday-overlay.dragon .title{color:#0e7a48}
            #holiday-overlay.mid .backdrop{background:radial-gradient(1200px 800px at 50% 20%,rgba(255,250,230,.95),rgba(255,240,200,.92),rgba(245,230,180,.9))}
            #holiday-overlay.mid .btn{background:linear-gradient(90deg,#ffd36b,#ffb347);color:#5a3a0a}
            #holiday-overlay.mid .title{color:#c08500}
            #holiday-overlay .dragonboat{position:absolute;bottom:10%;left:30%;width:320px;height:120px;display:none;z-index:1}
            #holiday-overlay.dragon .dragonboat{display:block;animation:boatMove 12s linear infinite}

            /* 船身主体 */
            #holiday-overlay .dragonboat .boat {
              position: absolute;
              bottom: 20px;
              left: 0;
              width: 360px;
              height: 40px;
              background: linear-gradient(180deg, #c98a3f, #8a5628);
              border-radius: 0 0 26px 26px;
              box-shadow: 0 6px 10px rgba(0, 0, 0, .18);
              overflow: visible;
            }

            /* 船身金色花纹 */
            #holiday-overlay .dragonboat .boat::after {
              content: "";
              position: absolute;
              inset: 0;
              border-radius: inherit;
              background: repeating-linear-gradient(
                      90deg,
                      rgba(255, 230, 150, .5) 0 12px,
                      transparent 12px 24px
              );
              opacity: .4;
            }

            /* 龙头 */
            #holiday-overlay .dragonboat .head {
              position: absolute;
              left: -12px;
              bottom: 45px;
              width: 70px;
              height: 55px;
              background: radial-gradient(circle at 40% 40%, #2ecc71, #178046);
              border-radius: 40% 40% 30% 30% / 40% 40% 60% 60%;
              transform: rotate(-6deg);
            }

            /* 龙角 */
            #holiday-overlay .dragonboat .head::before {
              content: "";
              position: absolute;
              top: -6px;
              left: 8px;
              width: 18px;
              height: 18px;
              background: #f2c94c;
              border-radius: 4px 12px 4px 12px;
              transform: rotate(40deg);
            }

            /* 龙眼 */
            #holiday-overlay .dragonboat .head::after {
              content: "";
              position: absolute;
              right: 10px;
              top: 18px;
              width: 10px;
              height: 10px;
              background: #fff;
              border-radius: 50%;
              box-shadow: 0 0 0 4px #d62828 inset;
            }

            /* 龙尾 */
            #holiday-overlay .dragonboat .tail {
              position: absolute;
              right: -16px;
              bottom: 32px;
              width: 46px;
              height: 46px;
              background: radial-gradient(circle at 60% 40%, #2ecc71, #178046);
              clip-path: polygon(0 50%, 100% 0, 60% 100%);
              transform: rotate(12deg);
            }

            /* 水波 */
            #holiday-overlay .dragonboat .wave {
              position: absolute;
              bottom: 0;
              left: 0;
              width: 100%;
              height: 14px;
              background: repeating-linear-gradient(
                      90deg,
                      rgba(159, 230, 255, 0.7) 0 14px,
                      rgba(120, 200, 240, 0.7) 14px 28px
              );
              border-radius: 10px;
              filter: blur(1px);
              animation: wave 2.2s linear infinite;
            }

            /* 龙舟漂浮动画 */
            @keyframes boatFloat {
              0% {
                transform: translateY(0);
              }
              50% {
                transform: translateY(-6px);
              }
              100% {
                transform: translateY(0);
              }
            }

            /* 原移动动画保留 */
            @keyframes boatMove {
              0% {
                transform: translateX(0);
              }
              100% {
                transform: translateX(150%);
              }
            }

            /*#holiday-overlay .dragonboat .head{position:absolute;left:10px;bottom:28px;width:38px;height:26px;background:linear-gradient(180deg,#22c55e,#16a34a);border-radius:20px 18px 0 18px}*/
            /*#holiday-overlay .dragonboat .flag{position:absolute;right:30px;bottom:40px;width:0;height:0;border-left:0;border-right:20px solid transparent;border-bottom:30px solid #ff6b6b}*/
            /*#holiday-overlay .dragonboat .wave{position:absolute;bottom:0;left:0;width:100%;height:12px;background:repeating-linear-gradient(90deg,rgba(159,230,255,.7) 0 12px,rgba(120,200,240,.7) 12px 24px);border-radius:8px;filter:blur(1px);animation:wave 2s linear infinite}*/
            /*@keyframes boatMove{0%{transform:translateX(0)}100%{transform:translateX(140%)}}*/
            /*@keyframes wave{0%{transform:translateX(0)}100%{transform:translateX(-40px)}}*/
            #holiday-overlay .mooncake{position:absolute;top:12%;right:10%;width:110px;height:110px;border-radius:50%;background:radial-gradient(circle at 50% 50%,#ffeb99 0%,#ffd36b 60%,#f5b041 100%);box-shadow:0 10px 20px rgba(0,0,0,.18);display:none;z-index:1}
            #holiday-overlay.mid .mooncake{display:block;animation:mooncakeSpin 10s linear infinite}
            #holiday-overlay .mooncake::after{content:"";position:absolute;inset:16px;border-radius:50%;background:repeating-radial-gradient(circle,#f1c27d 0 6px,transparent 6px 12px)}
            @keyframes mooncakeSpin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
            #holiday-overlay .confetti .p:nth-child(odd){border-radius:50%}
            #holiday-overlay .confetti .p:nth-child(1){left:12%;top:-10%;background:#ff6b6b;animation:fall 6s linear infinite}
            #holiday-overlay .confetti .p:nth-child(2){left:24%;top:-12%;background:#ffd36b;animation:fall 7s linear infinite}
            #holiday-overlay .confetti .p:nth-child(3){left:36%;top:-8%;background:#9fe6ff;animation:fall 6.5s linear infinite}
            #holiday-overlay .confetti .p:nth-child(4){left:48%;top:-14%;background:#b9e672;animation:fall 7.2s linear infinite}
            #holiday-overlay .confetti .p:nth-child(5){left:60%;top:-9%;background:#ff94c2;animation:fall 6.3s linear infinite}
            #holiday-overlay .confetti .p:nth-child(6){left:72%;top:-11%;background:#ffa07a;animation:fall 7.1s linear infinite}
            #holiday-overlay .confetti .p:nth-child(7){left:84%;top:-13%;background:#87cefa;animation:fall 6.8s linear infinite}
            #holiday-overlay .confetti .p:nth-child(8){left:18%;top:-15%;background:#f0e68c;animation:fall 7.4s linear infinite}
            #holiday-overlay .confetti .p:nth-child(9){left:30%;top:-16%;background:#dda0dd;animation:fall 7.6s linear infinite}
            #holiday-overlay .confetti .p:nth-child(10){left:54%;top:-17%;background:#98fb98;animation:fall 6.9s linear infinite}
            @keyframes popIn{0%{transform:scale(.86);opacity:0}100%{transform:scale(1);opacity:1}}
            @keyframes glow{0%{filter:blur(12px)}50%{filter:blur(18px)}100%{filter:blur(12px)}}
            @keyframes fall{0%{transform:translate(0,0) rotate(0deg)}50%{transform:translate(40px,340px) rotate(120deg)}100%{transform:translate(80px,680px) rotate(240deg);opacity:0}}
          #holiday-overlay
            .backdrop
            canvas#holidayFX
            .card
              .title 节日祝福
              .date#holiday-date
              .msg#holiday-msg 愿你被好运和温柔包围，节日快乐
              button.btn#holiday-ok 收下祝福
            .dragonboat
              .boat
              .head
              .flag
              .tail
              .wave
            .mooncake
            .confetti
              .p
              .p
              .p
              .p
              .p
              .p
              .p
              .p
              .p
              .p
          script(defer).
            (function(){
              var urlParams = new URLSearchParams(location.search);
              var overrideDate = urlParams.get('date');
              var today = overrideDate ? new Date(overrideDate) : new Date();
              var yyyy = today.getFullYear();
              var mm = String(today.getMonth()+1).padStart(2,'0');
              var dd = String(today.getDate()).padStart(2,'0');
              var todayStr = yyyy + '-' + mm + '-' + dd;
              function nthWeekdayOfMonth(year, month/*1-12*/, weekday/*0-6*/, n){
                var d = new Date(year, month-1, 1);
                var diff = (weekday - d.getDay() + 7) % 7;
                d.setDate(1 + diff + (n-1)*7);
                return d;
              }
              var solarFixed = {
                '01-01':'元旦快乐',
                '02-14':'情人节快乐',
                '03-08':'妇女节快乐',
                '04-01':'愚人节开心',
                '05-01':'劳动节快乐',
                '06-01':'儿童节快乐',
                '10-01':'国庆节快乐',
                '12-25':'圣诞节快乐'
              };
              var mothers = nthWeekdayOfMonth(yyyy,5,0,2); // 五月第2个周日
              var fathers = nthWeekdayOfMonth(yyyy,6,0,3); // 六月第3个周日
              var solarDynamic = {};
              solarDynamic[String(mothers.getMonth()+1).padStart(2,'0')+'-'+String(mothers.getDate()).padStart(2,'0')] = '母亲节快乐';
              solarDynamic[String(fathers.getMonth()+1).padStart(2,'0')+'-'+String(fathers.getDate()).padStart(2,'0')] = '父亲节快乐';
              var lunarInfo=[0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,0x06ca0,0x0b550,0x15355,0x04da0,0x0a5d0,0x14573,0x052d0,0x0a9a8,0x0e950,0x06aa0,0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,0x0b5a0,0x195a6,0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570,0x04af5,0x04970,0x064b0,0x074a3,0x0ea50,0x06b58,0x05ac0,0x0ab60,0x096d5,0x092e0,0x0c960,0x0d954,0x0d4a0,0x0da50,0x07552,0x056a0,0x0abb7,0x025d0,0x092d0,0x0cab5,0x0a950,0x0b4a0,0x0baa4,0x0ad50,0x055d9,0x04ba0,0x0a5b0,0x15176,0x052b0,0x0a930,0x07954,0x06aa0,0x0ad50,0x05b52,0x04b60,0x0a6e6,0x0a4e0,0x0d260,0x0ea65,0x0d530,0x05aa0,0x076a3,0x096d0,0x04bd7,0x04ad0,0x0a4d0,0x1d0b6,0x0d250,0x0d520,0x0dd45,0x0b5a0,0x056d0,0x055b2,0x049b0,0x0a577,0x0a4b0,0x0aa50,0x1b255,0x06d20,0x0ada0,0x14b63];
              function lYearDays(y){var i,sum=348;for(i=0x8000;i>0x8;i>>=1){sum+=((lunarInfo[y-1900]&i)?1:0);}return(sum+leapDays(y));}
              function leapMonth(y){return(lunarInfo[y-1900]&0xf);}
              function leapDays(y){if(leapMonth(y)){return((lunarInfo[y-1900]&0x10000)?30:29);}return(0);}
              function monthDays(y,m){return((lunarInfo[y-1900]&(0x10000>>m))?30:29);}
              function solarToLunar(objDate){var baseDate=new Date(1900,0,31);var offset=(objDate-baseDate)/86400000;var i, temp=0;var year,month,day;for(i=1900;i<2100&&offset>0;i++){temp=lYearDays(i);offset-=temp;}if(offset<0){offset+=temp;i--; }year=i;var leap=leapMonth(i);var isLeap=false;for(month=1;month<13&&offset>0;month++){temp=monthDays(i,month); if(leap>0&&month==leap+1&&!isLeap){--month; temp=leapDays(i); isLeap=true;} else if(isLeap&&month==leap+1){isLeap=false;} offset-=temp;} if(offset==0&&leap>0&&month==leap+1){ if(isLeap){isLeap=false;} else {isLeap=true; --month;} } if(offset<0){ offset+=temp; --month;} day=offset+1; return {year:year,month:month,day:day,leap:isLeap};}
              var lunarFest = {
                '1-1':'新年快乐',
                '1-15':'元宵节快乐',
                '5-5':'端午安康',
                '7-7':'七夕快乐',
                '8-15':'中秋团圆',
                '9-9':'重阳安康',
                '12-8':'腊八快乐'
              };
              // var testDates = ['2025-11-23'];
              var reason = null, festType = null;
              var festParam = urlParams.get('fest');
              // if (festParam){ festType = festParam; reason = '测试节日'; }
              // if (testDates.indexOf(todayStr)>=0){ reason = '今天是测试日期'; festType = 'dragon'; }
              if (solarFixed[mm+'-'+dd]){ reason = solarFixed[mm+'-'+dd]; }
              else if (solarDynamic[mm+'-'+dd]){ reason = solarDynamic[mm+'-'+dd]; }
              else { var l = solarToLunar(today); var key = l.month + '-' + l.day; if (lunarFest[key]){ reason = lunarFest[key]; if(key==='1-1') festType='spring'; else if(key==='5-5') festType='dragon'; else if(key==='8-15') festType='mid'; } }
              var shownKey = 'holidayPopupShown_'+ todayStr;
              if (!reason) return;
              if (sessionStorage.getItem(shownKey)) return;
              var overlay = document.getElementById('holiday-overlay');
              var msgEl = document.getElementById('holiday-msg');
              var dateEl = document.getElementById('holiday-date');
              var okBtn = document.getElementById('holiday-ok');
              var fxCanvas = document.getElementById('holidayFX');
              var fxCtx = fxCanvas.getContext('2d');
              function fxResize(){ fxCanvas.width = window.innerWidth; fxCanvas.height = window.innerHeight; }
              fxResize();
              var rockets = [], sparks = [], running = false;
              function addFirework(){ var x = Math.random()*fxCanvas.width*0.8 + fxCanvas.width*0.1; var y = fxCanvas.height*0.75; var tx = x; var ty = Math.random()*fxCanvas.height*0.35 + fxCanvas.height*0.1; rockets.push({x,y,tx,ty,vx:0,vy:-6-Math.random()*3,life:0}); }
              function burst(x,y){ for(var i=0;i<60;i++){ var a = Math.random()*Math.PI*2; var s = 1+Math.random()*3; sparks.push({x:x,y:y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:0,max:50,color:`hsl(${Math.floor(Math.random()*360)},90%,60%)`}); } }
              function loop(){ fxCtx.clearRect(0,0,fxCanvas.width,fxCanvas.height); for(var i=rockets.length-1;i>=0;i--){ var r=rockets[i]; r.x+=r.vx; r.y+=r.vy; r.vy+=0.08; r.life++; fxCtx.fillStyle='#fff'; fxCtx.fillRect(r.x,r.y,2,2); if(r.vy>=0||r.life>80){ burst(r.x,r.y); rockets.splice(i,1); } }
                for(var j=sparks.length-1;j>=0;j--){ var p=sparks[j]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.02; p.life++; var a=Math.max(0,1-p.life/p.max); fxCtx.globalAlpha=a; fxCtx.fillStyle=p.color; fxCtx.beginPath(); fxCtx.arc(p.x,p.y,2,0,Math.PI*2); fxCtx.fill(); fxCtx.globalAlpha=1; if(p.life>p.max) sparks.splice(j,1); }
                if(running) requestAnimationFrame(loop);
              }
              function startFireworks(){ running=true; loop(); fwTimer=setInterval(addFirework, 900); }
              function stopFireworks(){ running=false; clearInterval(fwTimer); }
              msgEl.innerText = reason + '，祝你心想事成';
              dateEl.innerText = '今日：' + todayStr;
              overlay.classList.add('on', festType || 'generic');
              if(festType==='spring'){ startFireworks(); }
              okBtn.addEventListener('click', function(){ overlay.classList.remove('on'); sessionStorage.setItem(shownKey,'1'); });
              overlay.addEventListener('click', function(e){ if(e.target.id==='holiday-overlay'|| e.target.classList.contains('backdrop')){ overlay.classList.remove('on'); sessionStorage.setItem(shownKey,'1'); }});
              overlay.addEventListener('transitionend', function(){ if(!overlay.classList.contains('on')){ stopFireworks(); } });
              window.addEventListener('resize', fxResize);
            })();

        if (theme.agreementPopup && theme.agreementPopup.enable && is_home_first_page())
          - let agreementPopupUrl = theme.agreementPopup.url
          script(defer).
            var hasShownPopup = sessionStorage.getItem('sessionNegotiatePopupShown');

            if (!hasShownPopup) {
              setTimeout(() => {
                anzhiyuPopupManager && anzhiyuPopupManager.enqueuePopup('协议提醒助手', '查看本站为你的个人隐私做出的努力', '#{agreementPopupUrl}', 4000);
                sessionStorage.setItem('sessionNegotiatePopupShown', 'true');
              }, 1000);
            }

    else
      include ./404.pug

    !=partial('includes/sidebar', {}, {cache: true})

    if theme.shortcutKey.enable
      !=partial('includes/shortcutKey', {}, {cache: true})
    include ./rightside.pug

    if (theme.nav_music.enable || theme.nav_music.console_widescreen_music)
      include ./music.pug
    !=partial('includes/third-party/search/index', {}, {cache: true})
    !=partial('includes/anzhiyu/rightmenu', {}, {cache:true})
    include ./additional-js.pug

    //- 弹窗通知
    !=partial('includes/popup/index', {}, {cache: true})
